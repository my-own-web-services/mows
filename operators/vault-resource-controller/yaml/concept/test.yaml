apiVersion: vault.k8s.mows.cloud/v1
kind: VaultResource
metadata:
    name: pektin-db-passwords
    namespace: pektin
spec:
    secretEngine:
        kv-v2:
            kvData:
                some_path:
                    server-password: "abc"
                    api-password: "{% randAlphaNum  %}"
---

apiVersion: vault.k8s.mows.cloud/v1
kind: VaultResource
metadata:
    name: pektin-db-passwords-sync
    namespace: pektin
spec:
    secretSync:
        kvMapping:
            serverPassword: # name in the template engine
                engine: pektin-db-passwords # name of the secretEngine in the same namespace as the resource
                path: "some_path/server-password" # path to the secret in the secretEngine
                raw: true # mount as struct or as raw value ????
            apiPassword: 
                engine: pektin-db-passwords
                path: "some_path/api-password"
        targets:
            redis-acl: # name of the secret in the same namespace
                delimiter: # delimiter for the template engine (optional) will be replaced with {{ and }} by string replacement, default is {% %}
                    start: "{%"
                    end: "%}"
                template: |
                    user default off
                    user db-pektin-server on resetchannels allkeys -@all +GET +MGET +KEYS +SELECT {% .Secrets.serverPassword | sha256sum %}
                    user db-pektin-api on resetchannels allkeys -@all +SET +GET +MSET +MGET +DEL +KEYS +SELECT {% .Secrets.apiPassword | sha256sum %}
            redis-pektin-server-password:
                template: |
                    {% .Secrets.serverPassword %}
            redis-pektin-api-password:
                template: |
                    {% .Secrets.apiPassword %}


