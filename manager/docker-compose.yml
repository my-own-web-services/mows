services:
    mows-manager:
        image: mows-manager
        container_name: mows-manager
        build:
            context: "."
            dockerfile: docker/manager.Dockerfile
        init: true # without this the mows manager cant start a pty process
        networks:
            mows-manager-pxe:
                ipv4_address: "192.168.112.3"
            mows-manager:
        dns:
            - "192.168.112.3"
        cap_add:
          - "NET_ADMIN"
        ports:
            - "127.0.0.1:3000:3000"
            - "127.0.0.1:6669:6669"
            - "127.0.0.1:8001:8001"
            - "127.0.0.1:53:53"
        volumes:
            - ./temp/:/temp/
            - ./install:/install
            - /etc/resolv.conf.bak:/etc/resolv.conf.bak
        environment:
            LIBVIRT_DEFAULT_URI: qemu+tcp://qemu/system # qemu+tcp://localhost/system
            #- RUST_BACKTRACE=full
            RUST_LOG: main=debug,manager=debug,tower_http=error,axum::rejection=trace,tokio=debug,runtime=debug,russh=error,manager::config_locks=error
    qemu:
        image: qemu
        restart: always
        init: true
        privileged: true
        container_name: qemu
        build:
            context: "."
            dockerfile: docker/qemu.Dockerfile
        ports:
            - "127.0.0.1:16509:16509"
            - "127.0.0.1:5900-5999:5900-5999" # spice
            - "127.0.0.1:5700-5799:5700-5799" # vnc websocket 

        cap_add:
          - "NET_ADMIN"
        devices:
          - "/dev/kvm"
        networks:
            mows-manager-pxe:
                ipv4_address: "192.168.112.4"
            # we need two networks because the pxe network is bridged
            mows-manager:


networks:
    mows-manager:
        name: mows-manager
        
    mows-manager-pxe:
        name: mows-manager-pxe
        driver: bridge
        ipam:
            driver: default
            config:
                - subnet: 192.168.112.0/24
                  gateway: "192.168.112.1"
        driver_opts:
            com.docker.network.bridge.name: pxe
            com.docker.network.container_iface_prefix: pxe
        

