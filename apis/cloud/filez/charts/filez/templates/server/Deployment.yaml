apiVersion: apps/v1
kind: Deployment
metadata:
    name: {{ .Values.server.name }}
spec:
    replicas: {{ .Values.server.replicaCount }}
    selector:
        matchLabels:
            app: {{ .Values.server.name }}
    template:
        metadata:
            labels:
                app: {{ .Values.server.name }}
        spec:
            serviceAccountName: {{ .Values.server.name }}
            containers:
                -   name: {{ .Values.server.name }}
                    image: "{{ .Values.server.image }}"
                    imagePullPolicy: {{ .Values.server.imagePullPolicy }}
                    securityContext:
                        allowPrivilegeEscalation: false
                        readOnlyRootFilesystem: true
                        runAsNonRoot: true
                        runAsUser: 50003
                    ports:
                        -   name: http
                            containerPort: 8080
                            protocol: TCP
                    resources:
                        limits:
                            memory: 128Mi
                            cpu: 500m
                    env:
                        -   name: RUST_LOG
                            value: {{ .Values.server.rustLog }}
                        -   name: OIDC_CLIENT_ID
                            valueFrom:
                                secretKeyRef:
                                    name: filez-auth
                                    key: serverClientId
                        -   name: OIDC_CLIENT_SECRET
                            valueFrom:
                                secretKeyRef:
                                    name: filez-auth
                                    key: serverClientSecret
                        -   name: OIDC_ISSUER
                            valueFrom:
                                secretKeyRef:
                                    name: filez-auth
                                    key: issuer
                        -   name: PRIMARY_ORIGIN
                            value: "https://filez-api.{ยง .config.domain ยง}"
                        -   name: ENABLE_DEV
                            value: {{ .Values.server.dev.enabled | quote }}
                        -   name: DEV_ALLOW_ORIGINS
                            value: {{ .Values.server.dev.allowedCorsOrigins | quote }}
                        -   name: DATABASE_URL
                            valueFrom:
                                secretKeyRef:
                                    name: filez-db-user-connection-string
                                    key: connectionString