version: "3.9"
services:
    filez-db:
        build:
            context: ./db/
            dockerfile: Dockerfile
        container_name: filez-db
        restart: always
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: root
        healthcheck:
            test: |
                test $$(mongosh --quiet -u root -p root --eval "try { rs.initiate({ _id: 'rs0', members: [{ _id: 0, host: 'filez-db' }] }).ok } catch (_) { rs.status().ok }") -eq 1
            interval: 10s
            start_period: 10s
        networks:
            - filez-db
    filez-ui:
        container_name: filez-ui
        build:
            context: ./web/
            dockerfile: Dockerfile
        restart: always
        volumes:
            - ./identity/filez-ui.cert:/identity.cert
        environment:
            CONFIG_URL: ${CONFIG_URL}
    filez-api:
        container_name: filez-api
        volumes:
            - ./identity/filez-api.cert:/identity.cert
        build:
            context: ./server/
            dockerfile: Dockerfile
        restart: always
        networks:
            - filez-db
        environment:
            CONFIG_URL: ${CONFIG_URL}
networks:
    filez-db:
        name: filez-db
